@model AccountViewModel

@{
    ViewBag.Title = "Accounts";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row" style="padding: 1rem 3rem;">
        <button class="btn btn-outline-secondary" onclick="showModal('@Model.ViiaConnectUrl')">Connect More Accounts</button>
        <button class="btn btn-outline-secondary" onclick="requestDataUpdate()">Request Data Update</button>
    </div>
    <div class="row" style="padding: 0 3rem;">
       
        <div class="col">
            @if (Model?.Accounts == null || !Model.Accounts.Any())
            {
                <p class="text-center">
                    You don't seem to have any accounts connected, try adding some.
                </p>
            }
            else
            {
                foreach (var account in Model.Accounts)
                 {
                     <div class="card" onclick="window.location.href = '@Url.Action("Transactions", "Viia", new {accountId = account.Id})'">
                         <div class="card-body">
                             <h5 class="card-title">
                                 @account.Name
                             </h5>
                             <div class="row">
                                 <div class="col-6 text-left">
                                     <p>Account no</p>
                                 </div>
                                 <div class="col-6 text-right">
                                     <p>@(account.Number?.Bban ?? account.Number?.Iban ?? "Unknown")</p>
                                 </div>
                             </div>
                             <div class="row">
                                 <div class="col-6 text-left">
                                     <p>Balance</p>
                                 </div>
                                 <div class="col-6 text-right">
                                     <p>@(account.AvailableBalance ?? account.BookedBalance) @account.Currency</p>
                                 </div>
                             </div>
                         </div>
                     </div>
                 }
            }
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div style="position: relative">
                <iframe id="viia-iframe" data-src="@Model.ViiaConnectUrl" style="position:absolute;top:0px;width:100%;height:50vh;" frameborder="0" allowtransparency="true"></iframe>

            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

@section Scripts
{
    <script>
        function showModal(url) {
            var iframe = $('#viia-iframe');
            iframe.attr("src", url);
            $('#myModal').modal('show');
        }
        
        function bindEvent(element, eventName, eventHandler) {
            if (element.addEventListener) {
                element.addEventListener(eventName, eventHandler, false);
            } else if (element.attachEvent) {
                element.attachEvent('on' + eventName, eventHandler);
            }
        }

        $(document).ready(function() {
            bindEvent(window, 'message', function (e) {
                $('#myModal').modal('hide');
                console.log("Hiding modal");
            });
        });
        
        function requestDataUpdate() {
            $.ajax({
                url: '/viia/update',
                type: 'POST',
                dataType: "json",
                success: function(data) {
                    if (data.authUrl) {
                        // Auth url not empty or null means we need a supervised login
                        showModal(data.authUrl);

                    } else {
                        console.log("Supervised login not needed. Data sync started");
                        // refresh page?
                    }
                }
            });
        }
    </script>
}
