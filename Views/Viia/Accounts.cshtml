@model AccountViewModel

@{
    ViewBag.Title = "Accounts";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row" style="padding: 1rem 3rem;">
        <button class="btn btn-outline-secondary" onclick="showModal('@Model.ViiaConnectUrl')">Connect More Accounts</button>
        <button class="btn btn-outline-secondary" onclick="requestDataUpdate()">Request Data Update</button>
    </div>
    <div class="row" style="padding: 0 3rem;">

        <div class="col">
            @if (Model?.AccountsGroupedByProvider == null || !Model.AccountsGroupedByProvider.Any())
            {
                <p class="text-center">
                    You don't seem to have any accounts connected, try adding some.
                </p>
            }
            else
            {
                foreach (var group in Model.AccountsGroupedByProvider)
                {
                    <div class="mb-4">
                        <div class="d-flex flex-column justify-content-between align-items-start">
                            <label class="form-check-label grey-text pb-1  provider-label" for="account-@group.Key">
                                @group.Key
                            </label>
                            @foreach (var account in Model.AccountsGroupedByProvider[group.Key])
                            {
                                <div class="d-flex w-100 open-sans-light text-description">
                                    <div
                                        class="d-flex flex-column account-container background justify-content-between w-100 align-items-start"
                                        onclick="window.location.href = '@Url.Action("Transactions", "Viia", new {accountId = account.Id})'">
                                        <label class="form-check-label text-description open-sans-bold" for="account-@account.Id">
                                            @account.Name
                                        </label>
                                        <div class="d-flex grey-text">
                                            <label class="mb-0" translate>Account Number</label>
                                            @if (account.Number?.Bban != null || account.Number?.Iban != null)
                                            {
                                                <label
                                                    class="pl-1 mb-0"
                                                    for="account-@account.Id">
                                                    @(account.Number.Bban ?? account.Number.Iban)
                                                </label>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div style="position: relative">
                <iframe id="viia-iframe" data-src="@Model.ViiaConnectUrl" style="position: absolute; top: 0px; width: 100%; height: 50vh;" frameborder="0" allowtransparency="true"></iframe>

            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

@section Scripts
{
    <script>
        function showModal(url) {
            var iframe = $('#viia-iframe');
            iframe.attr("src", url);
            $('#myModal').modal('show');
        }

        function bindEvent(element, eventName, eventHandler) {
            if (element.addEventListener) {
                element.addEventListener(eventName, eventHandler, false);
            } else if (element.attachEvent) {
                element.attachEvent('on' + eventName, eventHandler);
            }
        }

        $(document).ready(function() {
            bindEvent(window,
                'message',
                function(e) {
                    $('#myModal').modal('hide');
                    console.log("Hiding modal");
                });
        });

        function requestDataUpdate() {
            $.ajax({
                url: '/viia/update',
                type: 'POST',
                dataType: "json",
                success: function(data) {
                    if (data.authUrl) {
                        // Auth url not empty or null means we need a supervised login
                        showModal(data.authUrl);

                    } else {
                        console.log("Supervised login not needed. Data sync started");
                        // refresh page?
                    }
                }
            });
        }
    </script>
}